name: Release to Maven Central

on:
  push:
    tags:
      - '*.*.*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up JDK 22
        uses: actions/setup-java@v4
        with:
          java-version: '22'
          distribution: 'temurin'
      
      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: 'latest'
      
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
          restore-keys: ${{ runner.os }}-gradle-
      
      - name: Build JAR
        run: ./gradlew clean jar --no-daemon
        shell: bash
      
      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: jar-${{ matrix.os }}
          path: build/libs/*.jar
          retention-days: 1

  publish:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Set up JDK 22
        uses: actions/setup-java@v4
        with:
          java-version: '22'
          distribution: 'temurin'
      
      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: 'latest'
      
      - name: Download JAR artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: jar-*
          path: platform-jars
      
      - name: Prepare platform JARs
        run: |
          mkdir -p platform-jars-classified
          VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
          
          declare -A platform_map=(
            ["ubuntu-latest"]="linux-x86_64"
            ["macos-latest"]="macos-aarch64"
            ["windows-latest"]="windows-x86_64"
          )
          
          for jar_dir in platform-jars/*/; do
            os=$(basename "$jar_dir" | sed 's/jar-//')
            platform=${platform_map[$os]:-$os}
            for jar in "$jar_dir"*.jar; do
              [ -f "$jar" ] || continue
              base=$(basename "$jar" .jar)
              [ "$base" = "fsst4j" ] && base="fsst4j-$VERSION"
              cp "$jar" "platform-jars-classified/${base}-${platform}.jar"
              echo "Added: ${base}-${platform}.jar"
            done
          done
      
      - name: Publish to Maven Central
        run: ./gradlew publishToMavenCentral -PplatformJarsDir=platform-jars-classified --no-daemon
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_PRIVATE_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: published-artifacts
          path: build/libs/*.jar
          retention-days: 90
