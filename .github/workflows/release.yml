name: Release to Maven Central

on:
  push:
    tags:
      - '*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        java-version: ['22']
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
      
      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v1.14
        with:
          cmake-version: 'latest'
      
      - name: Make gradlew executable
        if: runner.os != 'Windows'
        run: |
          if [ -f ./gradlew ]; then
            chmod +x ./gradlew
          fi
      
      - name: Extract version from tag
        if: github.event_name == 'push'
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash
      
      - name: Update version (Unix)
        if: github.event_name == 'push' && runner.os != 'Windows'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i.bak "s/version = \".*\"/version = \"$VERSION\"/" build.gradle.kts
        shell: bash
      
      - name: Update version (Windows)
        if: github.event_name == 'push' && runner.os == 'Windows'
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"
          $content = Get-Content build.gradle.kts -Raw
          $content = $content -replace 'version = ".*"', "version = `"$VERSION`""
          Set-Content build.gradle.kts -Value $content -NoNewline
        shell: pwsh
      
      - name: Update version (manual - Unix)
        if: github.event_name == 'workflow_dispatch' && runner.os != 'Windows'
        run: |
          VERSION="${{ github.event.inputs.version }}"
          sed -i.bak "s/version = \".*\"/version = \"$VERSION\"/" build.gradle.kts
        shell: bash
      
      - name: Update version (manual - Windows)
        if: github.event_name == 'workflow_dispatch' && runner.os == 'Windows'
        run: |
          $VERSION = "${{ github.event.inputs.version }}"
          $content = Get-Content build.gradle.kts -Raw
          $content = $content -replace 'version = ".*"', "version = `"$VERSION`""
          Set-Content build.gradle.kts -Value $content -NoNewline
        shell: pwsh
      
      - name: Cache Gradle dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Build JAR
        run: |
          if [ -f ./gradlew ]; then
            ./gradlew clean jar --no-daemon
          else
            gradle clean jar --no-daemon
          fi
        shell: bash
      
      - name: Upload JAR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jar-${{ matrix.os }}
          path: build/libs/*.jar
          retention-days: 1
      
      - name: Upload build directory
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}
          path: |
            build/
          retention-days: 1
          if-no-files-found: ignore

  publish:
    needs: build
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up JDK 22
        uses: actions/setup-java@v4
        with:
          java-version: '22'
          distribution: 'temurin'
      
      - name: Make gradlew executable
        run: |
          if [ -f ./gradlew ]; then
            chmod +x ./gradlew
          fi
      
      - name: Extract version from tag
        if: github.event_name == 'push'
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash
      
      - name: Update version
        if: github.event_name == 'push'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i.bak "s/version = \".*\"/version = \"$VERSION\"/" build.gradle.kts
        shell: bash
      
      - name: Update version (manual)
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ github.event.inputs.version }}"
          sed -i.bak "s/version = \".*\"/version = \"$VERSION\"/" build.gradle.kts
        shell: bash
      
      - name: Download all JAR artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: jar-*
          merge-multiple: false
          path: platform-jars
      
      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v1.14
        with:
          cmake-version: 'latest'
      
      - name: Build sources and javadoc (for main artifact)
        run: |
          if [ -f ./gradlew ]; then
            ./gradlew clean build sourcesJar javadocJar
          else
            gradle clean build sourcesJar javadocJar
          fi
        shell: bash
      
      - name: Prepare platform JARs with classifiers
        run: |
          mkdir -p platform-jars-classified
          # Map OS names to platform classifiers
          declare -A platform_map
          platform_map["ubuntu-latest"]="linux-x86_64"
          platform_map["macos-latest"]="macos-aarch64"
          platform_map["windows-latest"]="windows-x86_64"
          
          # Copy JARs with platform-specific names
          for jar_dir in platform-jars/*/; do
            os_name=$(basename "$jar_dir" | sed 's/jar-//')
            platform=${platform_map[$os_name]:-$os_name}
            
            for jar in "$jar_dir"*.jar; do
              if [ -f "$jar" ]; then
                # Extract base name and version (e.g., fsst4j-1.0.0)
                basename=$(basename "$jar" .jar)
                # Rename with platform classifier: fsst4j-1.0.0-linux-x86_64.jar
                cp "$jar" "platform-jars-classified/${basename}-${platform}.jar"
                echo "Copied $jar -> platform-jars-classified/${basename}-${platform}.jar"
              fi
            done
          done
          echo "Platform JARs prepared:"
          ls -la platform-jars-classified/
        shell: bash
      
      - name: Publish to Maven Central
        run: |
          if [ -f ./gradlew ]; then
            ./gradlew publish -PplatformJarsDir=platform-jars-classified
          else
            gradle publish -PplatformJarsDir=platform-jars-classified
          fi
        env:
          ORG_GRADLE_PROJECT_sonatypeUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_sonatypePassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_PRIVATE_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
        shell: bash
      
      - name: Upload published artifacts
        uses: actions/upload-artifact@v4
        with:
          name: published-artifacts
          path: build/libs/*.jar
          retention-days: 90
